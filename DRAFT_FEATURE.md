# 記事の下書き機能

記事を下書きとして保存し、任意のタイミングで公開できる機能を実装しました。

## 機能概要

### 1. 下書き保存
- 記事作成時に「📝 下書き保存」ボタンで下書きとして保存
- 記事は非公開状態で保存され、記事一覧ページには表示されません
- マイページの「下書き」タブから確認・編集可能

### 2. 記事の公開
- 記事作成時に「🚀 公開する」ボタンで即座に公開
- 下書きから「🚀 公開する」ボタンで公開に変更
- 公開済みの記事は記事一覧ページに表示されます

### 3. 公開から下書きへ戻す
- 編集ページで「📝 下書きに戻す」ボタンをクリック
- 記事を非公開に戻せます

### 4. マイページのタブ機能
- **🚀 公開済み**: 公開されている記事一覧
- **📝 下書き**: 下書き保存された記事一覧
- 各タブに記事数が表示されます

## データベース変更

### 新しいカラム: `status`

```sql
ALTER TABLE articles ADD COLUMN status VARCHAR(20) DEFAULT 'published' NOT NULL;
CREATE INDEX idx_articles_status ON articles(status);
```

**取りうる値:**
- `'draft'`: 下書き
- `'published'`: 公開済み

## セットアップ手順

### 1. Supabaseでマイグレーションを実行

Supabaseダッシュボード → SQL Editor にアクセスし、以下のSQLファイルを実行：

```sql
-- database/add-draft-status.sql の内容を実行
```

または、`database/add-draft-status.sql` ファイルをSupabase SQL Editorで実行してください。

### 2. アプリケーションを再起動

Dockerを使用している場合：

```bash
sudo docker compose down
sudo docker compose up --build
```

### 3. 動作確認

1. ログインして記事作成ページにアクセス
2. 「📝 下書き保存」ボタンが表示されることを確認
3. 下書きとして保存
4. マイページの「📝 下書き」タブに表示されることを確認
5. 編集ページから「🚀 公開する」で公開
6. マイページの「🚀 公開済み」タブに移動することを確認

## API変更

### POST /api/articles
**新しいパラメータ:**
- `status`: `'draft'` または `'published'` (デフォルト: `'published'`)

### PUT /api/articles/[slug]
**新しいパラメータ:**
- `status`: `'draft'` または `'published'` (省略可能)

### GET /api/articles
- 公開済み記事のみを返す（`status='published'`）

### GET /api/users/[userId]/articles
- ユーザーのすべての記事を返す（下書きと公開済みの両方）

## UI変更

### 記事作成ページ (`/articles/new`)
- **📝 下書き保存**: 下書きとして保存し、マイページ（下書きタブ）にリダイレクト
- **🚀 公開する**: 公開して記事ページにリダイレクト

### 記事編集ページ (`/articles/[slug]/edit`)

**下書きの場合:**
- **📝 下書き保存**: 下書きのまま更新
- **🚀 公開する**: 公開状態に変更

**公開済みの場合:**
- **📝 下書きに戻す**: 下書き状態に戻す
- **✓ 更新する**: 公開状態のまま更新

### マイページ (`/mypage`)
- タブで「公開済み」と「下書き」を切り替え
- 各記事カードに「📝 下書き」バッジを表示

## 技術詳細

### ステータス管理
- `status` カラムで記事の状態を管理
- 後方互換性のため `published` カラムも維持
- フロントエンドでステータスに応じたUIを動的に切り替え

### URLパラメータ
マイページで `?tab=drafts` パラメータを使用して下書きタブを直接開けます：
```
/mypage?tab=drafts
```

## トラブルシューティング

### Supabaseでstatusカラムが見つからない
→ `database/add-draft-status.sql` を実行してください

### 下書きボタンが表示されない
→ ブラウザのキャッシュをクリアして再読み込みしてください

### 下書き保存後にエラーが出る
→ コンソールログを確認し、ユーザー登録が正しく行われているか確認してください
